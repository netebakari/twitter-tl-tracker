# twitter-tl-tracker
Twitterのログを取りたい（なるべくたくさん）

# モチベーション
UserStreamが死んでしまったので少なくともそれと同等のツイートのログを取りたい

# 処理概要
* ホームTLを1分ごとに1回取得し、S3に格納する
  * 1分ごとでもいいけど同じAPIキーを何か他のことにも使い回しているなら2分おきが無難
  * 下手に使い回すと凍結されるという話があるのでむしろ1分おきが無難かも
* 自分がフォローしている人を一定時間（30分～1時間程度）おきに1回取得し、巡回するユーザーのリストを作成してSQSに突っ込む
* このリストに従い、ユーザーTLを取得してS3に格納する
* ホームTL・ユーザーTLのデータを後からマージして1日分のツイートのログとする
  * マージ処理は未実装

# 動作環境
* Lambda 
  * 今のところ処理は全部Lambda(Node.js v8.10)で書いている
* SQS
  * 上述の「巡回するユーザーのリスト」を格納する場所として利用
  * 定期的に自分がフォローしている人のリストを作成し、ユーザーIDだけを書いたメッセージをSQSに投入
  * ここに自分のフォロワーを加えることも可（ストーカー気質の人向け）
* DynamoDB
  * ホームTLおよびユーザーTLをどこまで取得したか管理するためにDynamoDBのテーブルを1件利用している
* S3
  * ツイートの出力先
  * 取得したツイートはJSON形式で `/fragments` 以下に格納する（Lambdaが1回起動するごとに1個作られる）
    * ホームTLは `/fragments/2018-08-20/TIMELINEv2_20180820.063923.920.json` のような名前
    * ユーザーTLは `/fragments/2018-08-20/USERv2_20180820.071617.530.json` のような名前
  * これを1日単位でマージして定期的に `/tweets` 以下に格納する

# インストール前の準備
## S3
ツイートを保存するためのバケットを用意する

## DynamoDB
テーブルを1個作成する。キーは `id_str` （文字列）とする
※レコードのサイズが非常に小さいためRCU/WCUは5程度で余裕

## SQS
キューを1個作成する。Default Visibility Timeoutは10分に、他の値はデフォルトでよい

## IAMロール
以上のリソースにアクセスできるIAMロールを作成する。これはLambdaに割り当てる

# ビルド＆デプロイ
```
git cone
npm install
```
それから `src/config.ts` を書き換え、

```
npx tsc
rm -rf node_modules/
npm install --production
npm run build
```

でアップロードするためのモジュールができる。これをもとに3個のLambdaを作る：

* キュー埋めLambda
  * ハンドラ: `index.hourlyTask`
  * 自動実行: 30分～1時間おき
* ホームTL取得Lambda
  * ハンドラ: `index.homeTimeline`
  * 自動実行: 2分おき
* ユーザーTL取得Lambda
  * ハンドラ: `index.userTL`
  * 自動実行: 5分おき（Configの設定に合わせる）
  * メモリ: 時間帯にもよるが、128MBだとギリギリかメモリが溢れて強制終了する。特に初回は全ユーザーの数日前からのツイートを取得しようとするため320MB～384MBあたりがオススメ（様子を見ながら小さくする）


# Todo
* マージ処理がクソ重たくて実用にならないのをなんとかする
* リソースを手動で作るのはダサいのでなんとかする

# なぜなに
## Configにベタ書きするな、環境変数に書け
します

## 暗号化しろ
やりたくない
* 暗号化したいキーは最低2つ、できれば4つ
* ホームTLは2分おき＆ユーザーTLは5分おきに起動（＝1時間に合計42回）
* これをかけると1ヶ月あたり12万回でKMSの無料枠をはみ出す（キー1個分の料金とあわせて$1.3ぐらい）
* ログを取るためだけのものに出したくない気持ち

## マージ処理を書け
Lambdaでやるのは無理な気がしてきた
